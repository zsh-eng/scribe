---
import Layout from "../layouts/Layout.astro";
import BudgetTreemapGraph from "../components/budgets/BudgetTreemapGraph.astro";
import SectorTrendChart from "../components/budgets/SectorTrendChart.astro";
import fs from "node:fs";
import path from "node:path";
import { hierarchy, treemap, treemapSquarify } from "d3-hierarchy";

const csvPath = path.join(
  process.cwd(),
  "..",
  "data",
  "GovernmentTotalExpenditure.csv",
);
const csvText = fs.readFileSync(csvPath, "utf-8");

function parseCSV(text: string) {
  const lines = text.trim().split("\n");
  return lines
    .slice(1)
    .map((line) => {
      const values: string[] = [];
      let current = "";
      let inQuotes = false;
      for (const char of line) {
        if (char === '"') {
          inQuotes = !inQuotes;
          continue;
        }
        if (char === "," && !inQuotes) {
          values.push(current.trim());
          current = "";
          continue;
        }
        current += char;
      }
      values.push(current.trim());
      return {
        year: parseInt(values[0]),
        estimateType: values[1],
        sector: values[2],
        ministry: values[3],
        expType: values[4],
        amount: parseFloat(values[5]) || 0,
      };
    })
    .filter((r) => !isNaN(r.year));
}

const rows = parseCSV(csvText);

const estimateTypePriority: Record<string, number> = {
  Estimated: 1,
  Revised: 2,
  Actual: 3,
};

const preferredEstimateTypeByYear = new Map<number, string>();
for (const row of rows) {
  const existing = preferredEstimateTypeByYear.get(row.year);
  if (!existing) {
    preferredEstimateTypeByYear.set(row.year, row.estimateType);
    continue;
  }
  const existingPriority = estimateTypePriority[existing] || 0;
  const rowPriority = estimateTypePriority[row.estimateType] || 0;
  if (rowPriority > existingPriority) {
    preferredEstimateTypeByYear.set(row.year, row.estimateType);
  }
}

const filteredRows = rows.filter(
  (row) => preferredEstimateTypeByYear.get(row.year) === row.estimateType,
);

const yearMap = new Map<
  number,
  Map<
    string,
    {
      sector: string;
      ministry: string;
      operating: number;
      development: number;
      estimateType: string;
    }
  >
>();

for (const row of filteredRows) {
  if (!yearMap.has(row.year)) yearMap.set(row.year, new Map());
  const entries = yearMap.get(row.year)!;
  const key = `${row.sector}|||${row.ministry}`;
  if (!entries.has(key)) {
    entries.set(key, {
      sector: row.sector,
      ministry: row.ministry,
      operating: 0,
      development: 0,
      estimateType: row.estimateType,
    });
  }
  const entry = entries.get(key)!;
  if (row.expType === "Operating") entry.operating += row.amount;
  else if (row.expType === "Development") entry.development += row.amount;
}

const W = 1000;
const H = 600;

const sectorOrder = [
  "Social Development",
  "Security and External Relations",
  "Economic Development",
  "Government Administration",
];

interface MinistryCell {
  name: string;
  value: number;
  operating: number;
  development: number;
  x0: number;
  y0: number;
  x1: number;
  y1: number;
}

interface SectorCell {
  name: string;
  value: number;
  x0: number;
  y0: number;
  x1: number;
  y1: number;
  ministries: MinistryCell[];
}

interface YearData {
  total: number;
  estimateType: string;
  sectors: SectorCell[];
}

const allTreemapData: Record<string, YearData> = {};

for (const [year, entries] of yearMap) {
  const entryList = [...entries.values()];

  const sectorGroups: Record<
    string,
    { name: string; value: number; operating: number; development: number }[]
  > = {};
  for (const e of entryList) {
    const total = e.operating + e.development;
    if (total <= 0) continue;
    if (!sectorGroups[e.sector]) sectorGroups[e.sector] = [];
    sectorGroups[e.sector].push({
      name: e.ministry,
      value: total,
      operating: e.operating,
      development: e.development,
    });
  }

  const children = sectorOrder
    .filter((s) => sectorGroups[s]?.length > 0)
    .map((s) => ({
      name: s,
      children: sectorGroups[s],
    }));

  if (children.length === 0) continue;

  const root = hierarchy({ name: "Budget", children })
    .sum((d: any) => d.value)
    .sort((a, b) => (b.value || 0) - (a.value || 0));

  treemap()
    .size([W, H])
    .tile(treemapSquarify)
    .paddingTop((d: any) => (d.depth === 0 ? 0 : 18))
    .paddingRight((d: any) => (d.depth === 0 ? 0 : 3))
    .paddingBottom((d: any) => (d.depth === 0 ? 0 : 3))
    .paddingLeft((d: any) => (d.depth === 0 ? 0 : 3))
    .paddingInner(2)(root as any);

  const totalBudget = root.value || 0;

  const sectors: SectorCell[] = (root.children || []).map((s: any) => ({
    name: s.data.name,
    value: s.value,
    x0: s.x0,
    y0: s.y0,
    x1: s.x1,
    y1: s.y1,
    ministries: (s.children || []).map((m: any) => ({
      name: m.data.name,
      value: m.value,
      operating: m.data.operating,
      development: m.data.development,
      x0: m.x0,
      y0: m.y0,
      x1: m.x1,
      y1: m.y1,
    })),
  }));

  allTreemapData[year] = {
    total: totalBudget,
    estimateType: entryList[0]?.estimateType || "Actual",
    sectors,
  };
}

const years = Object.keys(allTreemapData)
  .map(Number)
  .sort((a, b) => a - b);
const defaultYear = years[years.length - 1];

interface SectorTrendPoint {
  year: number;
  total: number;
  operating: number;
  development: number;
}

const sectorTrendSeries = sectorOrder
  .map((sector) => {
    const points: SectorTrendPoint[] = years
      .map((year) => {
        const entries = yearMap.get(year);
        let operating = 0;
        let development = 0;
        if (entries) {
          for (const entry of entries.values()) {
            if (entry.sector !== sector) continue;
            operating += entry.operating;
            development += entry.development;
          }
        }
        return {
          year,
          total: operating + development,
          operating,
          development,
        };
      })
      .filter((p) => p.total > 0);

    return { name: sector, points };
  })
  .filter((series) => series.points.length > 0);

const latestYear = defaultYear;
const previousYear = years[years.length - 2];
const latestData = allTreemapData[latestYear];
const previousData = previousYear ? allTreemapData[previousYear] : undefined;

const totalChangeAbs =
  latestData && previousData ? latestData.total - previousData.total : null;
const totalChangePct =
  totalChangeAbs !== null && previousData && previousData.total > 0
    ? (totalChangeAbs / previousData.total) * 100
    : null;

const fmtAmount = (millions: number, decimals = 1) => {
  if (millions >= 1000) return `S$${(millions / 1000).toFixed(decimals)}B`;
  return `S$${Math.round(millions).toLocaleString()}M`;
};

const fmtSignedAmount = (millions: number, decimals = 1) =>
  `${millions >= 0 ? "+" : "-"}${fmtAmount(Math.abs(millions), decimals)}`;

const fmtSignedPct = (value: number, decimals = 1) =>
  `${value >= 0 ? "+" : ""}${value.toFixed(decimals)}%`;

const isNegativeFullDrop = (previousTotal: number, latestTotal: number) =>
  previousTotal > 0 && latestTotal <= 0;

const sectorChangeRows = sectorOrder
  .map((sector) => {
    const latestPoint = sectorTrendSeries
      .find((series) => series.name === sector)
      ?.points.find((point) => point.year === latestYear);
    const previousPoint = sectorTrendSeries
      .find((series) => series.name === sector)
      ?.points.find((point) => point.year === previousYear);
    const latestTotal = latestPoint?.total || 0;
    const previousTotal = previousPoint?.total || 0;
    const change = latestTotal - previousTotal;
    return {
      sector,
      latestTotal,
      previousTotal,
      change,
      changePct:
        previousTotal > 0
          ? (change / previousTotal) * 100
          : latestTotal > 0
            ? 100
            : 0,
    };
  })
  .sort((a, b) => Math.abs(b.change) - Math.abs(a.change));

const rankedSectorChangeRows = sectorChangeRows.filter(
  (row) => !isNegativeFullDrop(row.previousTotal, row.latestTotal),
);

const topSectorChange = rankedSectorChangeRows[0];

const ministryTotalsByYear = new Map<
  number,
  Map<string, { sector: string; total: number }>
>();
for (const [year, entries] of yearMap) {
  const byMinistry = new Map<string, { sector: string; total: number }>();
  for (const entry of entries.values()) {
    const total = entry.operating + entry.development;
    if (total <= 0) continue;
    byMinistry.set(entry.ministry, {
      sector: entry.sector,
      total,
    });
  }
  ministryTotalsByYear.set(year, byMinistry);
}

const latestMinistryTotals = ministryTotalsByYear.get(latestYear) || new Map();
const previousMinistryTotals = previousYear
  ? ministryTotalsByYear.get(previousYear) || new Map()
  : new Map();

const ministryNames = new Set([
  ...latestMinistryTotals.keys(),
  ...previousMinistryTotals.keys(),
]);

const ministryChangeRows = [...ministryNames]
  .map((ministry) => {
    const latest = latestMinistryTotals.get(ministry);
    const previous = previousMinistryTotals.get(ministry);
    const latestTotal = latest?.total || 0;
    const previousTotal = previous?.total || 0;
    const change = latestTotal - previousTotal;
    const sector = latest?.sector || previous?.sector || "Unknown";
    return {
      ministry,
      sector,
      latestTotal,
      previousTotal,
      change,
      changePct:
        previousTotal > 0
          ? (change / previousTotal) * 100
          : latestTotal > 0
            ? 100
            : 0,
    };
  })
  .filter((row) => row.latestTotal > 0 || row.previousTotal > 0)
  .sort((a, b) => Math.abs(b.change) - Math.abs(a.change));

const rankedMinistryChangeRows = ministryChangeRows.filter(
  (row) => !isNegativeFullDrop(row.previousTotal, row.latestTotal),
);

const topMinistryChange = rankedMinistryChangeRows[0];
const majorMinistryMovers = rankedMinistryChangeRows.slice(0, 10);

const policySpotlights = [
  {
    pillar: "Businesses",
    tone: "Tax and innovation",
    items: [
      "40% corporate income tax rebate for YA2026.",
      "S$37B for frontier technologies under RIE2030.",
      "Startup SG Equity enhancements, including S$1B investment.",
      "250% tax deduction for eligible donations extended to end-2029.",
    ],
    links: [
      {
        label:
          "Official: Advancing Our Economic Strategy (Budget 2026 factsheet)",
        href: "https://isomer-user-content.by.gov.sg/34/51b2ffad-8dff-4469-af71-00c2a008a5b2/Advancing%20our%20Economic%20Strategy.pdf",
      },
      {
        label: "CNA: S$1 billion boost for Startup SG Equity",
        href: "https://www.channelnewsasia.com/singapore/budget-2026-tech-startups-1-billion-boost-growth-stage-companies-5925796",
      },
      {
        label: "CNA: RIE2030 S$37 billion investment",
        href: "https://www.channelnewsasia.com/singapore/national-research-foundation-research-innovation-enterprise-rie-2030-37-billion-5537496",
      },
    ],
  },
  {
    pillar: "Workers and talent",
    tone: "Skills and labour policy",
    items: [
      "National AI Missions and a new National AI Council.",
      "Redesigned SkillsFuture with six months of free premium AI tools.",
      "Higher qualifying salaries for EP and S Pass holders.",
      "Higher work permit levies for selected sectors.",
    ],
    links: [
      {
        label:
          "Official: Harnessing AI as a Strategic Advantage (Budget 2026 factsheet)",
        href: "https://isomer-user-content.by.gov.sg/34/16e9696a-7c39-4846-8c9a-2fd0e1ea2cbb/Harnessing%20AI.pdf",
      },
      {
        label: "CNA: National AI Council and AI Missions",
        href: "https://www.channelnewsasia.com/singapore/budget-2026-national-artificial-intelligence-council-ai-lawrence-wong-5925886",
      },
      {
        label: "CNA: Free premium AI tools via selected courses",
        href: "https://www.channelnewsasia.com/singapore/budget-2026-free-ai-subscription-training-courses-skillsfuture-5925621",
      },
      {
        label: "CNA: EP and S Pass qualifying salary increases",
        href: "https://www.channelnewsasia.com/singapore/budget-2026-foreign-workers-employment-pass-qualifying-salary-lower-wage-workers-5925671",
      },
    ],
  },
  {
    pillar: "Households",
    tone: "Support and transfers",
    items: [
      "S$500 extra Child LifeSG credits per Singaporean child aged 12 and below.",
      "Additional ComLink+ payouts for eligible low-income families.",
      "S$200-S$400 cash payouts, up to S$570 U-Save, and S$500 CDC vouchers.",
      "Up to S$1,500 CPF top-up for eligible Singaporeans aged 50 and above.",
    ],
    links: [
      {
        label: "Official: Support for Singaporeans (Budget 2026 factsheet)",
        href: "https://isomer-user-content.by.gov.sg/34/2dcfc177-c79f-47d9-a1ae-b2b5441bcd5c/Support%20for%20Singaporeans.pdf",
      },
      {
        label:
          "Official: Supporting Families with Children (Budget 2026 factsheet)",
        href: "https://isomer-user-content.by.gov.sg/34/6fed8368-47ef-4de6-8313-5941a2a9a8a9/Supporting%20Singaporeans%20%26%20Families%20with%20Children.pdf",
      },
      {
        label: "CNA: Cost-of-living cash, U-Save and CDC vouchers",
        href: "https://www.channelnewsasia.com/singapore/budget-2026-cost-living-payout-cdc-vouchers-5925606",
      },
      {
        label: "CNA: Additional S$500 Child LifeSG credits",
        href: "https://www.channelnewsasia.com/singapore/child-lifesg-credits-budget-2026-age-5925746",
      },
      {
        label: "CNA: New CPF life-cycle investment scheme",
        href: "https://www.channelnewsasia.com/singapore/budget-2026-cpf-life-cycle-investment-retirement-5925641",
      },
    ],
  },
  {
    pillar: "Other notable shifts",
    tone: "Fiscal signals",
    items: [
      "Defence spending remains around 3% of GDP, with room to rise if needed.",
      "Lower vehicle PARF rebates.",
      "Higher tobacco excise duty.",
      "New CPF investment scheme announced.",
    ],
    links: [
      {
        label: "Official: Budget 2026 overview page",
        href: "https://www.gov.sg/budget2026/",
      },
      {
        label: "CNA: Defence spending around 3% of GDP",
        href: "https://www.channelnewsasia.com/singapore/defence-security-spending-cybersecurity-budget-2026-5925711",
      },
      {
        label: "CNA: Tobacco excise duty increase",
        href: "https://www.channelnewsasia.com/singapore/budget-2026-tobacco-cigarettes-duty-tax-smoking-5925896",
      },
      {
        label: "CNA: Donations tax deduction extension to end-2029",
        href: "https://www.channelnewsasia.com/singapore/sg-partnerships-fund-charities-donations-budget-2026-5925911",
      },
      {
        label: "CNA: 7 key measures (includes PARF rebate changes)",
        href: "https://www.channelnewsasia.com/singapore/budget-2026-seven-things-you-need-know-5925866",
      },
    ],
  },
];
---

<Layout
  title="Budgets"
  description="Singapore Government Budget Expenditure Treemap"
>
  <header class="mb-6">
    <span class="section-label">Government Expenditure</span>
    <h1 class="page-title">Budget</h1>
    <p class="body-prose max-w-prose">
      How Singapore allocates its expenditure across sectors and ministries.
    </p>
  </header>

  {
    latestData && (
      <section class="mb-10">
        <div class="mb-3">
          <h2 class="font-masthead text-2xl text-ink tracking-tight leading-none">
            Budget {latestYear} At A Glance
          </h2>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 border border-border">
          <article class="p-4 border-b sm:border-b border-border lg:border-b-0 lg:border-r">
            <p class="font-sans text-[11px] uppercase tracking-wider text-ink-muted mb-2">
              Total Budget ({latestYear})
            </p>
            <p class="font-masthead text-3xl text-ink leading-none">
              {fmtAmount(latestData.total)}
            </p>
          </article>
          <article class="p-4 border-b sm:border-b border-border lg:border-b-0 lg:border-r">
            <p class="font-sans text-[11px] uppercase tracking-wider text-ink-muted mb-2">
              Year-On-Year Change
            </p>
            <p class="font-masthead text-3xl text-ink leading-none">
              {totalChangeAbs !== null
                ? fmtSignedAmount(totalChangeAbs)
                : "N/A"}
            </p>
            <p class="font-sans text-xs text-ink-muted mt-2">
              {totalChangePct !== null
                ? fmtSignedPct(totalChangePct)
                : "No prior-year comparison"}
            </p>
          </article>
          <article class="p-4 border-b border-border sm:border-b-0 lg:border-r">
            <p class="font-sans text-[11px] uppercase tracking-wider text-ink-muted mb-2">
              Largest Sector Shift
            </p>
            <p class="font-serif text-sm text-ink">
              {topSectorChange?.sector || "N/A"}
            </p>
            <p class="font-masthead text-2xl text-ink leading-none mt-1">
              {topSectorChange
                ? fmtSignedAmount(topSectorChange.change)
                : "N/A"}
            </p>
          </article>
          <article class="p-4">
            <p class="font-sans text-[11px] uppercase tracking-wider text-ink-muted mb-2">
              Largest Ministry Shift
            </p>
            <p class="font-serif text-sm text-ink">
              {topMinistryChange?.ministry || "N/A"}
            </p>
            <p class="font-masthead text-2xl text-ink leading-none mt-1">
              {topMinistryChange
                ? fmtSignedAmount(topMinistryChange.change)
                : "N/A"}
            </p>
          </article>
        </div>
      </section>
    )
  }

  <BudgetTreemapGraph
    data={allTreemapData}
    width={W}
    height={H}
    years={years}
    defaultYear={defaultYear}
  />

  <SectorTrendChart trendSeries={sectorTrendSeries} years={years} />

  <section class="mt-10">
    <div class="mb-3">
      <h2 class="font-masthead text-2xl text-ink tracking-tight leading-none">
        Largest Ministry Shifts
      </h2>
    </div>
    <div
      class="budget-ministry-shifts-table border border-border overflow-x-auto"
    >
      <table class="w-full min-w-[760px] border-collapse">
        <thead>
          <tr class="border-b border-border">
            <th
              class="text-left p-3 font-sans text-[11px] uppercase tracking-wider text-ink-muted"
              >Ministry</th
            >
            <th
              class="text-left p-3 font-sans text-[11px] uppercase tracking-wider text-ink-muted"
              >Sector</th
            >
            <th
              class="text-right p-3 font-sans text-[11px] uppercase tracking-wider text-ink-muted"
              >{previousYear || latestYear - 1}</th
            >
            <th
              class="text-right p-3 font-sans text-[11px] uppercase tracking-wider text-ink-muted"
              >{latestYear}</th
            >
            <th
              class="text-right p-3 font-sans text-[11px] uppercase tracking-wider text-ink-muted"
              >Change</th
            >
            <th
              class="text-right p-3 font-sans text-[11px] uppercase tracking-wider text-ink-muted"
              >Change %</th
            >
          </tr>
        </thead>
        <tbody>
          {
            majorMinistryMovers.map((row) => (
              <tr class="border-b border-border last:border-b-0">
                <td class="p-3 font-serif text-[15px] text-ink">
                  {row.ministry}
                </td>
                <td class="p-3 font-sans text-xs text-ink-muted">
                  {row.sector}
                </td>
                <td class="p-3 font-sans text-sm text-right text-ink-muted">
                  {fmtAmount(row.previousTotal)}
                </td>
                <td class="p-3 font-sans text-sm text-right text-ink">
                  {fmtAmount(row.latestTotal)}
                </td>
                <td class="p-3 font-sans text-sm text-right text-ink">
                  {fmtSignedAmount(row.change)}
                </td>
                <td class="p-3 font-sans text-sm text-right text-ink">
                  {fmtSignedPct(row.changePct)}
                </td>
              </tr>
            ))
          }
        </tbody>
      </table>
    </div>
  </section>

  <p class="font-sans text-xs text-ink-muted mt-4">
    Source: Singapore Government Total Expenditure, data.gov.sg. Amounts in S$
    millions.
  </p>
</Layout>

<style is:global>
  @media (max-width: 640px) {
    .budget-ministry-shifts-table {
      width: 100vw;
      margin-left: calc(50% - 50vw);
      margin-right: calc(50% - 50vw);
      border-left: 0;
      border-right: 0;
    }
  }
</style>
